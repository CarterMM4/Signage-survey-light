<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Signage Survey Tool</title>
<style>
  body { margin: 0; font-family: Arial, sans-serif; background: #f3f4f6; color: #111; }
  header { background: #111827; color: white; padding: 10px; display: flex; align-items: center; justify-content: space-between; }
  header h1 { margin: 0; font-size: 18px; }
  button { padding: 6px 12px; margin: 2px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
  button:hover { background: #1e40af; }
  main { display: flex; height: calc(100vh - 50px); }
  #sidebar { width: 250px; background: #e5e7eb; padding: 10px; overflow-y: auto; }
  #stageContainer { flex: 1; position: relative; background: #fff; display: flex; align-items: center; justify-content: center; overflow: auto; }
  #stageImage { max-width: 100%; max-height: 100%; }
  .pin { position: absolute; width: 14px; height: 14px; background: red; border-radius: 50%; cursor: pointer; transform: translate(-50%, -50%); }
</style>
</head>
<body>

<header>
  <h1>Signage Survey Tool</h1>
  <div>
    <button id="btnNew">New Project</button>
    <button id="btnOpen">Open</button>
    <button id="btnRename">Rename</button>
    <button id="btnUpload">Upload</button>
    <input type="file" id="inputUpload" style="display:none" multiple>
  </div>
</header>

<main>
  <div id="sidebar">
    <button id="btnAddPin">Add Pin</button>
    <button id="btnClearPins">Clear Pins</button>
    <button id="btnExportCSV">Export CSV</button>
    <button id="btnExportXLSX">Export XLSX</button>
  </div>
  <div id="stageContainer">
    <img id="stageImage">
    <div id="pinLayer" style="position:absolute;top:0;left:0;right:0;bottom:0;"></div>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  let projects = [], project = null;
  const stageImage = document.getElementById('stageImage');
  const pinLayer = document.getElementById('pinLayer');
  const inputUpload = document.getElementById('inputUpload');

  function id(){ return Math.random().toString(36).slice(2,10); }
  function newProject(name){ return { id:id(), name, createdAt:Date.now(), updatedAt:Date.now(), pages:[], pins:[] }; }
  function saveProject(p){ const idx = projects.findIndex(x=>x.id===p.id); if(idx>=0) projects[idx]=p; else projects.push(p); localStorage.setItem('projects', JSON.stringify(projects)); }
  function loadProjects(){ try { return JSON.parse(localStorage.getItem('projects')||'[]'); } catch { return []; } }
  
  function renderPins(){
    pinLayer.innerHTML = '';
    (project.pins||[]).forEach(pin=>{
      const el = document.createElement('div');
      el.className = 'pin';
      el.style.left = pin.x_pct + '%';
      el.style.top = pin.y_pct + '%';
      el.dataset.id = pin.id;
      el.onclick = () => alert(`Pin: ${pin.id}`);
      pinLayer.appendChild(el);
    });
  }

  document.getElementById('btnNew').onclick = ()=>{
    const name = prompt('Project name?');
    if(!name) return;
    project = newProject(name);
    saveProject(project);
  };

  document.getElementById('btnOpen').onclick = ()=>{
    const items = projects.map(p=>`${p.name} (${p.id})`).join('\n');
    const idv = prompt('Enter project id:\n' + items);
    const found = projects.find(p=>p.id===idv);
    if(found) project = found;
  };

  document.getElementById('btnRename').onclick = ()=>{
    if(!project) return;
    const name = prompt('New name?', project.name);
    if(name) { project.name = name; saveProject(project); }
  };

  document.getElementById('btnUpload').onclick = ()=> inputUpload.click();

  inputUpload.onchange = async (e)=>{
    const files = [...e.target.files];
    for(const f of files){
      if(f.type==='application/pdf'){
        const url = URL.createObjectURL(f);
        const pdf = await pdfjsLib.getDocument(url).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({scale:2});
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({canvasContext:canvas.getContext('2d'), viewport}).promise;
        stageImage.src = canvas.toDataURL('image/png');
      } else if(f.type.startsWith('image/')){
        stageImage.src = URL.createObjectURL(f);
      }
    }
  };

  document.getElementById('btnAddPin').onclick = ()=>{
    pinLayer.onclick = (e)=>{
      const rect = pinLayer.getBoundingClientRect();
      const x_pct = ((e.clientX - rect.left) / rect.width) * 100;
      const y_pct = ((e.clientY - rect.top) / rect.height) * 100;
      project.pins.push({ id:id(), x_pct, y_pct });
      saveProject(project);
      renderPins();
      pinLayer.onclick = null;
    };
  };

  document.getElementById('btnClearPins').onclick = ()=>{
    if(confirm('Clear all pins?')) { project.pins = []; saveProject(project); renderPins(); }
  };

  document.getElementById('btnExportCSV').onclick = ()=>{
    let csv = "id,x_pct,y_pct\n" + project.pins.map(p=>`${p.id},${p.x_pct},${p.y_pct}`).join("\n");
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (project.name||'project') + '.csv';
    a.click();
  };

  document.getElementById('btnExportXLSX').onclick = ()=>{
    alert('XLSX export not implemented in this demo.');
  };

  projects = loadProjects();
  if(projects.length) project = projects[0];
</script>
</body>
</html>
